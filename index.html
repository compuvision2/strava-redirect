<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Strava Redirect</title>
</head>
<body style="font-family: sans-serif; text-align: center; padding: 2rem;">
    <h2>Strava Autorisierung</h2>
    <p id="msg" style="margin-bottom: 2rem;">Verarbeite Antwort...</p>

    <script>
      (function () {
        const params = new URLSearchParams(window.location.search);
        const code = params.get("code");
        const state = params.get("state");
        const error = params.get("error");
        const errorDescription = params.get("error_description");
        const scope = params.get("scope");

        const appSchemeBase = "packkernel://oauth/strava/callback";
        const androidPackage = "com.dietmar.packlist.debug";

        const msg = document.getElementById("msg");

        function escapeHtml(s) {
          return String(s).replace(/[&<>"']/g, c => ({
            "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"
          }[c]));
        }

        function buildUrl(base, kv) {
          const q = Object.entries(kv)
            .filter(([,v]) => v !== null && v !== undefined && v !== "")
            .map(([k,v]) => `${encodeURIComponent(k)}=${encodeURIComponent(v)}`)
            .join("&");
          return q ? `${base}?${q}` : base;
        }

        function goToApp(customUrl) {
          msg.textContent = "Öffne die PackWISE App…";

          // 1) Direktversuch (Custom Scheme)
          window.location.replace(customUrl);

          // 2) Android-Fallback via intent:// 
          setTimeout(() => {
            const u = new URL(customUrl);
            const intentUrl =
              `intent://${u.host}${u.pathname}${u.search}#Intent;scheme=${u.protocol.replace(":", "")};package=${androidPackage};end`;
            window.location.href = intentUrl;
          }, 250);

          // 3) Fallback Button (manuell) - sehr wichtig für manche Android-Geräte!
          setTimeout(() => {
            msg.innerHTML =
              "Falls die App sich nicht automatisch öffnet:<br><br>" +
              "<a href='" + escapeHtml(customUrl) + "' style='padding: 12px 24px; background: #FC4C02; color: #fff; text-decoration: none; border-radius: 6px; display: inline-block; font-weight: bold; font-size: 16px; margin-top: 10px;'>Hier klicken, um PackWISE zu öffnen</a>";
          }, 1500);
        }

        if (error) {
          goToApp(buildUrl(appSchemeBase, { error, error_description: errorDescription, state }));
          return;
        }

        if (!code) {
          msg.innerHTML = "Fehler: Kein Login-Code von Strava erhalten.";
          return;
        }

        goToApp(buildUrl(appSchemeBase, { code, state, scope }));
      })();
    </script>
</body>
</html>
